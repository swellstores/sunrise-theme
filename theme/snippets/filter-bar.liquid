{%- liquid
  assign color_scheme = color_scheme
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign request_path = request.path | default: '#'
-%}

<div class="text-{{ color_scheme }}">
  <button
    data-trigger="filter-drawer"
    type="button"
    aria-expanded="false"
    class="inline-block text-title-small font-display"
  >
    <span class="flex gap-8 items-center">
      {{- 'filter-sort-icon.svg' | inline_asset_content -}}
      {{ 'sections.collection.filters.filter_and_sort' | t -}}
    </span>
  </button>

  <!-- Filter drawer -->
  <div
    data-target="filter-drawer"
    class="fixed top-0 left-0 h-full w-340 lg:w-400 bg-white hidden"
    style="z-index: 5000"
    role="dialog"
    aria-modal="true"
    aria-expanded="false"
  >
    <div class="flex flex-col h-full">
      <!-- Header -->
      <div class="flex items-center justify-between p-16 border-b border-gray-200">
        <h3 class="font-display text-title-large">{{ 'sections.collection.filters.filters' | t }}</h3>
        <button
          data-trigger="filter-drawer"
          type="button"
          class="flex h-40 w-40 items-center justify-center"
        >
          <span class="sr-only">{{ 'sections.collection.filters.close' | t }}</span>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 1L1 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M1 1L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Filters Form -->
      <form
        id="filter-form-stack"
        hx-get="{{ request_path }}"
        hx-trigger="change from:(#filter-form-stack input)"
        hx-on="htmx:configRequest: updateSortFilters(event)"
        hx-target="#results"
        hx-select="#results"
        hx-swap="outerHTML"
        hx-swap-oob="true"
        class="flex-1 overflow-y-auto"
      >
        <div class="p-16">
          {% for filter in results.filters %}
            <details
              class="filter-section mb-16"
              {% unless forloop.first %}
                open
              {% endunless %}
            >
              <summary class="flex items-center justify-between py-8 list-none cursor-pointer">
                <h4 class="text-title-medium font-display">{{ filter.label }}</h4>
                <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </summary>
              <div class="filter-options mt-8">
                {% if filter.type == 'list' %}
                  <div class="flex flex-col gap-12">
                    <!-- Add "All" option -->
                    <label class="flex items-center justify-between">
                      <div class="flex items-center">
                        <input
                          type="checkbox"
                          class="mr-12"
                          name="{{ filter.param_name }}_all"
                          value="all"
                          {% if filter.active_values.size == 0 %}
                            checked
                          {% endif %}
                        >
                        <span class="font-display">All</span>
                      </div>
                    </label>
                    {% for option in filter.values %}
                      {% render 'filter-input', filter: filter, option: option %}
                    {% endfor %}
                  </div>
                {% else %}
                  {% render 'filter-input', filter: filter %}
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>

        <!-- Clear All Button -->
        <div class="border-t border-gray-200 p-16">
          <button
            type="button"
            class="w-full py-12 px-24 bg-white border border-gray-900 text-center text-body-large font-display"
            onclick="window.location.href = '{{ results.url }}'"
          >
            {{ 'sections.collection.filters.clear_all' | t }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Active filters -->
  <section aria-labelledby="filter-heading">
    <h2 id="filter-heading" class="sr-only">{{ 'sections.collection.filters.filters' | t }}</h2>

    <!-- Active filter list -->
    {% liquid
      assign active_filter_count = 0
      assign active_price_range = false
      for filter in results.filters
        if filter.type == 'price_range'
          if filter.min_value.value or filter.max_value.value
            assign active_filter_count = active_filter_count | plus: 1
            assign active_price_range = true
          endif
        else
          if filter.active_values.size > 0
            assign active_filter_count = active_filter_count | plus: 1
          endif
        endif
      endfor
    %}

    <div id="active-filters" hx-swap-oob="true">
      {% if active_filter_count > 0 %}
        <div class="bg-{{ color_scheme }} py-12 sm:flex sm:justify-between sm:items-center">
          <span class="sr-only">{{ 'sections.collection.filters.active' | t }}</span>
          <div class="-m-4 flex flex-wrap items-center">
            {% for filter in results.filters %}
              {% if filter.type == 'price_range' %}
                {% if active_price_range %}
                  {% render 'filter-tag', filter: filter, color_scheme: color_scheme %}
                {% endif %}
              {% else %}
                {% for value in filter.active_values %}
                  {% render 'filter-tag', filter: filter, value: value, color_scheme: color_scheme %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          </div>
          <div class="clear-all">
            <a
              href="{{ results.url }}"
              class="text-{{ color_scheme }} underline-offset-2 hover:underline"
              hx-boost="true"
              hx-push-url="true"
              hx-target="#results"
              hx-select="#results"
              hx-swap="outerHTML"
            >
              {{ 'sections.collection.filters.clear_all' | t }}
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterDrawer = document.querySelector('[data-target="filter-drawer"]');
    const header = document.querySelector('header');
    const announcement = document.querySelector('announcement-root');
    const searchDialog = document.querySelector('search-dialog-root');

    // Override the original onClickFilterDrawer function
    window.onClickFilterDrawer = function () {
      const target = document.querySelector('[data-target="filter-drawer"]');
      const isExpanded = target.getAttribute('aria-expanded') === 'true';

      // Toggle drawer
      target.setAttribute('aria-expanded', !isExpanded);
      target.classList.toggle('hidden');

      // Update z-index of other components
      if (header) {
        header.classList.toggle('z-60');
        header.classList.toggle('z-10');
      }

      if (announcement) {
        announcement.classList.toggle('z-60');
        announcement.classList.toggle('z-10');
      }

      if (searchDialog) {
        searchDialog.classList.toggle('z-50');
      }
    };

    // Initialize price sliders on DOM load
    if (window.initPriceSliders) {
      window.initPriceSliders();
    }
  });

  document.addEventListener('htmx:afterSwap', function () {
    const params = new URLSearchParams(window.location.search);

    document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
      const paramName = checkbox.name;
      const paramValue = checkbox.value;

      if (!params.has(paramName) || !params.getAll(paramName).includes(paramValue)) {
        checkbox.checked = false;
      }
    });

    const results = document.querySelector('#results');

    if (results) {
      results.classList.add('opacity-20');
    }

    if (window.initPriceSliders) {
      window.initPriceSliders();
    }
  });

  document.addEventListener('htmx:oobAfterSwap', (event) => {
    const element = event.target;

    if (element.id === 'filter-form-bar' && window.filters) {
      window.filters();
    }
  });

  document.body.addEventListener('htmx:beforeRequest', function (event) {
    const results = document.querySelector('#results');

    if (results) {
      results.classList.add('opacity-20');
    }
  });

  document.addEventListener('htmx:configRequest', (event) => {
    if (window.onHtmxConfigRequest) {
      window.onHtmxConfigRequest(event);
    }
  });
</script>

{{ 'filter.js' | asset_url | script_tag }}

{% style %}
  .filter-section {
    border-bottom: 1px solid #e5e5e5;
  }

  .filter-section:last-child {
    border-bottom: none;
  }

  .filter-section[open] summary svg {
    transform: rotate(180deg);
  }

  .filter-section .filter-options {
    padding-bottom: 1.5rem;
  }

  .price-slider {
    margin-top: 1rem !important;
  }

  input[type='checkbox'] {
    width: 20px;
    height: 20px;
    border-radius: 2px;
    appearance: none;
    background-color: #fff;
    display: inline-block;
    cursor: pointer;
    border: 1px solid #222222;
    position: relative;
  }

  input[type='checkbox']:checked {
    background-color: #222222;
    border-color: #222222;
  }

  input[type='checkbox']:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 12px;
    height: 8px;
    border: 2px solid #fff;
    border-top: 0;
    border-right: 0;
    transform: translate(-50%, -65%) rotate(-45deg);
  }

  input[type='checkbox']:disabled {
    background-color: #e5e5e5;
    border-color: #e5e5e5;
    cursor: not-allowed;
  }
{% endstyle %}
