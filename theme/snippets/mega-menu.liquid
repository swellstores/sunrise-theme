{%- liquid
  assign border_b = section.settings.border_b
-%}

<div class="mega-nav-wrapper normal-case">
  <div class="absolute top-full left-0 w-full bg-white shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
    <div class="max-w-7xl mx-auto px-8 py-6">
      <div class="flex gap-8">
        <!-- Left Column - Categories -->
        <div class="w-64 border-r border-gray-100">
          <div class="pr-8">
            <div class="text-gray-900 font-medium mb-4">{{ current_link.title }}</div>
            <ul class="space-y-3">
              {% for child_link in current_link.links %}
                {% if child_link.links.size > 0 %}
                  <li>
                    <a 
                      href="{{ child_link.url }}" 
                      class="text-gray-600 hover:text-gray-900 text-sm transition-colors {% if child_link.active %}text-gray-900{% endif %}"
                    >
                      {{ child_link.title | escape }}
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Right Column - Featured Items Grid -->
        <div class="flex-1">
          <div class="grid grid-cols-3 gap-8">
            {% for child_link in current_link.links %}
              {% if child_link.links.size > 0 %}
                {% for grandchild in child_link.links limit: 3 %}
                  <div class="group">
                    <a href="{{ grandchild.url }}" class="block">
                      {% if grandchild.object.featured_image != blank %}
                        <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden bg-gray-100 rounded-lg mb-4">
                          <img
                            src="{{ grandchild.object.featured_image | img_url: '300x300', crop: 'center' }}"
                            alt="{{ grandchild.title | escape }}"
                            class="object-cover w-full h-full transform group-hover:scale-105 transition-transform duration-200"
                          >
                        </div>
                      {% endif %}

                      <h3 class="text-sm font-medium text-gray-900">
                        {{ grandchild.title }}
                      </h3>

                      {% if grandchild.object.price %}
                        <p class="mt-1 text-sm text-gray-500">
                          {{ grandchild.object.price | money }}
                        </p>
                      {% endif %}
                    </a>
                  </div>
                {% endfor %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  class MegaMenuTrigger extends HTMLElement {
    constructor() {
      super();
      this.addEventListener('mouseenter', () => {
        const megaMenu = this.nextElementSibling;
        if (megaMenu) {
          megaMenu.classList.remove('hidden');
        }
      });
      
      this.addEventListener('mouseleave', (event) => {
        const megaMenu = this.nextElementSibling;
        const toElement = event.relatedTarget;
        
        if (megaMenu && !megaMenu.contains(toElement)) {
          megaMenu.classList.add('hidden');
        }
      });
    }
  }

  if (!customElements.get('mega-menu-trigger')) {
    customElements.define('mega-menu-trigger', MegaMenuTrigger);
  }
</script>

{% schema %}
{
  "name": "Mega Menu",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "show_images",
      "label": "Show product images",
      "default": true
    }
  ]
}
{% endschema %}
