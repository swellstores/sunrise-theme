{%- liquid
  assign border_b = section.settings.border_b
  assign alignment = section.settings.mega_menu_alignment | default: 'center'
  
  if alignment == 'center'
    assign max_items_per_row = 4
  else
    assign max_items_per_row = 5
  endif
  
  assign total_items = current_link.links.size
  
  if total_items < max_items_per_row and alignment == 'center'
    assign items_per_row = total_items
  else
    assign items_per_row = max_items_per_row
  endif
  
  assign number_of_rows = total_items | divided_by: items_per_row | ceil
  assign columns_minus_one = total_items | minus: 1
-%}

<div class="mega-menu-grid {% if alignment == 'left' %}align-left{% endif %}">
  <div class="mega-menu-items" 
    {% if alignment == 'center' %}
      {% if total_items < 4 %}
        style="grid-template-columns: repeat({{ columns_minus_one }}, 220px) auto; margin: 0 auto;"
      {% else %}
        style="grid-template-columns: repeat(3, 220px) auto; margin: 0 auto;"
      {% endif %}
    {% else %}
      style="grid-template-columns: repeat({{ items_per_row }}, 220px);"
    {% endif %}
  >
    {% for child_link in current_link.links %}
      {% assign is_fourth_item = forloop.index | modulo: 4 %}
      {% assign is_last_item = forloop.index == total_items %}
      
      {% assign add_auto_width = false %}
      {% if total_items >= 4 and is_fourth_item == 0 and alignment == 'center' %}
        {% assign add_auto_width = true %}
      {% endif %}
      {% if total_items < 4 and is_last_item and alignment == 'center' %}
        {% assign add_auto_width = true %}
      {% endif %}
      
      <div class="mega-menu-category {% if add_auto_width %}auto-width{% endif %}">
        <a href="{{ child_link.url }}" class="font-semibold text-sm hover:underline leading-[22px]">
          {{ child_link.title }}
        </a>
        {% if child_link.links.size > 0 %}
          <div class="flex flex-col gap-4">
            {% for grandchild in child_link.links %}
              <a href="{{ grandchild.url }}" class="hover:underline font-normal font-heading leading-[20px]">
                {{ grandchild.title }}
              </a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>