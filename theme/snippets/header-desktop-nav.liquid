{% style %}
  .mega-menu-wrapper,
  .standard-dropdown {
    display: none;
    background-color: white;
    border: 1px solid #f5f5f5;
    box-shadow:
      0px 2px 4px -2px #1717170f,
      0px 4px 8px -2px #1717171a;
  }

  .standard-dropdown {
    position: absolute;
    top: 100%;
    margin-left: 24px;
    padding: 32px 16px;
    transform: translateY(-22px);
  }

  .mega-menu-wrapper {
    width: 100%;
    display: none;
    visibility: hidden;
    opacity: 0;
    z-index: -1;
    height: auto;
    position: absolute;
    left: 0;
  }

  .mega-menu-wrapper.active {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 1000 !important;
  }

  .mega-menu-wrapper.active * {
    visibility: visible !important;
    opacity: 1 !important;
  }

  .mega-menu-grid {
    display: block;
    column-width: 250px;
    column-gap: 32px;
    column-fill: auto;
    width: 100%;
    max-width: 1440px;
    margin: 0 auto;
    padding: 32px 120px;
    max-height: 628px;
    overflow: hidden;
    color: #111827;
    z-index: 1001;
    background-color: white;
  }

  .mega-menu-category {
    break-inside: avoid;
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 32px;
  }

  .hover-bridge {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 1px;
    margin-top: -1px;
    background: transparent;
  }

  .nav-item {
    position: relative;
    height: 100%;
  }

  .group:hover .standard-dropdown,
  .group:hover .hover-bridge {
    display: block;
  }

  .mega-menus-container {
    position: absolute;
    left: 0;
    width: 100%;
    z-index: 30;
    height: auto;
    pointer-events: none;
    transform: translateY(26px);
  }

  .mega-menu-wrapper.active {
    pointer-events: auto;
  }

  .nav-container {
    position: relative;
    width: 100%;
    max-width: 1440px;
    margin: 0 auto;
    z-index: 40;
    height: 100%;
  }

  header {
    position: relative;
    z-index: 50;
  }

  {% for link in menu_links %}
    {% if link.links.size > 0 %}
      {% assign has_grandchild = false %}
      {% for child in link.links %}
        {% if child.links.size > 0 %}
          {% assign has_grandchild = true %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endstyle %}

<script>
  // Mega menu toggle functions
  function showMegaMenu(id) {
    const megaMenu = document.getElementById(id);
    if (megaMenu) {
      megaMenu.classList.add('active');
    }
  }

  function keepMenuVisible(id) {
    const megaMenu = document.getElementById(id);
    if (megaMenu) {
      megaMenu.classList.add('active');
    }
  }

  function hideMegaMenu(id) {
    const megaMenu = document.getElementById(id);
    if (megaMenu) {
      setTimeout(() => {
        if (
          !document.querySelector(`#${id}:hover`) &&
          !document.querySelector(`[data-nav-item]:hover a[onmouseover*="${id}"]`)
        ) {
          megaMenu.classList.remove('active');
        }
      }, 100);
    }
  }
</script>

<nav role="navigation" class="flex justify-center h-full items-center w-full">
  <div class="nav-container">
    <ul class="flex gap-3 h-full justify-center items-center md:gap-[48px]">
      {% assign selected_menu = section.settings.selected_menu | default: 'main-menu' %}
      {% assign menu_links = linklists[selected_menu].links %}

      {% for link in menu_links %}
        <li
          class="nav-item font-display flex h-full items-center group"
          data-nav-item="{{ forloop.index }}"
        >
          <a
            href="{{ link.url }}"
            class="flex h-full items-center whitespace-nowrap hover:underline font-normal font-display leading-[20px] text-sm"
            {% if link.links.size > 0 %}
              {% assign has_grandchild = false %}
              {% for child in link.links %}
                {% if child.links.size > 0 %}
                  {% assign has_grandchild = true %}
                {% endif %}
              {% endfor %}
              {% if has_grandchild %}
                onmouseover="showMegaMenu('mega-menu-{{ forloop.index }}', event)"
                onmouseout="hideMegaMenu('mega-menu-{{ forloop.index }}')"
              {% endif %}
            {% endif %}
          >
            {{ link.title }}
            {% if link.links.size > 0 %}
              <div class="ml-2 flex items-center justify-center">
                <ion-icon
                  name="chevron-down-outline"
                  aria-label="Toggle accordion item"
                  class="h-5 w-5 transition-transform"
                ></ion-icon>
              </div>
            {% endif %}
          </a>

          {% if link.links.size > 0 %}
            <div class="hover-bridge"></div>
            {% assign has_grandchild = false %}
            {% for child in link.links %}
              {% if child.links.size > 0 %}
                {% assign has_grandchild = true %}
              {% endif %}
            {% endfor %}

            {% unless has_grandchild %}
              {% render 'standard-dropdown', links: link.links %}
            {% endunless %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
</nav>

<div class="mega-menus-container">
  {% for link in menu_links %}
    {% if link.links.size > 0 %}
      {% assign has_grandchild = false %}
      {% for child in link.links %}
        {% if child.links.size > 0 %}
          {% assign has_grandchild = true %}
        {% endif %}
      {% endfor %}

      {% if has_grandchild %}
        <div
          id="mega-menu-{{ forloop.index }}"
          class="mega-menu-wrapper"
          onmouseover="keepMenuVisible('mega-menu-{{ forloop.index }}')"
          onmouseout="hideMegaMenu('mega-menu-{{ forloop.index }}')"
        >
          {% render 'mega-menu', current_link: link %}
        </div>
      {% endif %}
    {% endif %}
  {% endfor %}
</div>
